<!DOCTYPE html>
<html lang="en">
<head>
    <title>漳州窑开光青花雉鸡牡丹大盘</title>
    <meta http-equiv="cache-control" content="must- revalidate">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="../css/main.css" type="text/css">
    <link rel="stylesheet" href="../css/share.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <script src="../js/libs/jquery.js"></script>
    <script src="../js/libs/TweenMax.min.js"></script>
    <!-- 分享插件 -->
    <script src="../js/social-share.js"></script>
    <script src="../js/qrcode.js"></script>
    <!-- 分享插件 -->
    <script src="../js/jquery-1.11.0.min.js"></script>
    <script src="../js/www.js"></script>
</head>
<body>
<div class="ww-title wwPos">
    【 漳州窑开光青花雉鸡牡丹大盘 】
</div>
<!-- <div class="ww-btn1 wwPos"></div>
 <div class="ww-btn2 wwPos"></div>
 <!-- 右侧顶部 -->
<div class="ww-content wwPos" style="height: 0;display: block;top: 0;">
    <div class="ww-contTitle">
        <img src="../images/new/desc.png" width="270" height="122">
        <div class="ww-close"></div>
    </div>
    <div class="ww-text">
        <div class="ww-ContentP">
            <p>收藏于：福建中国闽台缘博物馆</p>
            <p style="margin-bottom: 8px;">年代：明代</p>
            <p>规格：高10.2，口径46.4，底径21.5厘米</p>

            <p class="" style="margin-top: 20px;">
                口沿至腹部绘窗格纹地六开光假石菊花，盘底双弦纹内绘太阳、雉鸡牡丹图，雉鸡站立于左右两朵缠枝牡丹之中，尾部呈绶带状。
                口沿至腹部绘窗格纹地六开光假石菊花，盘底双弦纹内绘太阳、雉鸡牡丹图，雉鸡站立于左右两朵缠枝牡丹之中，尾部呈绶带状。
            </p>
        </div>
        <div class="mouseTip"><span></span></div>
    </div>
</div>
<!-- 换背景按钮 -->

<!-- 右侧底部 -->
<div class="ww_btnList wwPos">
    <a href="">
        <div class="ww_home ww_icon"></div>
    </a>
    <div class="ww_vioce ww_icon"></div>
    <div class="ww_help ww_icon"></div>
    <div class="ww-share ww_share ww_icon"></div>
    <div class="ww-shareList ww_icon social-share" data-initialized="true">
        <a href="#" class="ww-shareWx ww-icon icon-wechat"></a>
        <a href="#" class="ww-shareQq ww-icon icon-qq"></a>
        <a href="#" class="ww-shareWb ww-icon icon-weibo"></a>
        <div class="ww-shareCl ww_shareCl ww_icon"></div>
    </div>
    <div class="rbox2 huanbjbox" style="display: none;">
        <span class="huanbj huanbj1" title="1"></span>
        <span class="huanbj huanbj2" title="2"></span>
        <span class="huanbj huanbj3" title="3"></span>
    </div>

</div>
<!-- 帮助手册 -->
<div class="helpManual">
    <div class="closeBtn">
        <img src="../images/closeBtn.png" alt="" />
    </div>
    <!-- PC端 -->
    <div class="helpPc">
        <div class="cir">
            <div class="helpImg"><img src="../images/png7.png" alt=""></div>
            <div class="helpText">旋转</div>
            <div class="helpText">鼠标左键</div>
        </div>
        <div class="cir">
            <div class="helpImg"><img src="../images/png8.png" alt=""></div>
            <div class="helpText">缩放</div>
            <div class="helpText">鼠标滚轮</div>
        </div>
        <div class="cir">
            <div class="helpImg"><img src="../images/png9.png" alt=""></div>
            <div class="helpText">平移</div>
            <div class="helpText">长按滚轮</div>
        </div>
        <div class="cir">
            <div class="helpImg"><img src="../images/png10.png" alt=""></div>
            <div class="helpText">复原</div>
            <div class="helpText">左键双击</div>
        </div>
    </div>
    <!-- 手机端 -->
    <div class="helpPhone">
        <div class="cirPhone">
            <div class="helpImgPhone"><img src="../images/png22.png" alt=""></div>
            <div class="helpTextPhone">旋转</div>
            <div class="helpTextPhone">1根手指</div>
        </div>
        <div class="cirPhone">
            <div class="helpImgPhone"><img src="../images/png23.png" alt=""></div>
            <div class="helpTextPhone">缩放</div>
            <div class="helpTextPhone">2根手指</div>
        </div>
        <div class="cirPhone">
            <div class="helpImgPhone"><img src="../images/png24.png" alt=""></div>
            <div class="helpTextPhone">平移</div>
            <div class="helpTextPhone">3根手指</div>
        </div>
        <div class="cirPhone">
            <div class="helpImgPhone"><img src="../images/png25.png" alt=""></div>
            <div class="helpTextPhone">复原</div>
            <div class="helpTextPhone">双击屏幕</div>
        </div>
    </div>
</div>
<!-- 手机端分享提示 -->
<div class="phoneShare">
    <img src="../images/share.png" alt="分享" />
</div>

<!-- 文物语音 -->
<audio id="wwMusic">
    <source src="../audio/MTY002235.mp3" type="audio/mpeg">
    您的浏览器不支持声音
</audio>
<!-- 背景音乐 -->
<audio id="bgMusic" autoplay loop="loop">
    <source src="../bgMusic.mp3" type="audio/mpeg">
    您的浏览器不支持声音
</audio>

<div class="confirm">
    <div class="dialog">
        <div class="dialog-header">下载需要41MB，是否下载？</div>
        <div class="dialog-footer">
            <input type="button" class="btn" id="confirm" value="确定">
            <input type="button" class="btn ml50" id="cancel" value="取消">
        </div>
    </div>
</div>
<div class="annotation"></div>

<div id="leftImg" style="display: none;"></div>
<div id="rightImg"></div>

<div id="bgColors">
    <div class="huan_bj huanbj1" data-index="1"></div>
    <div class="huan_bj huanbj2" data-index="2"></div>
    <div class="huan_bj huanbj3" data-index="3"></div>
</div>

<div id="bottomButtons">
    <div id="reset" class="reset button"></div>
    <div id="rotate" class="rotate button"></div>
    <div id="bgColor" class="color button"></div>
</div>

<script>
    var html = '<div class="loading">' +
        '<div class="loading_t" style="margin-top: ' + (window.innerHeight / 2 - 60) + 'px;"><img src="../images/logo.png" width="60" height="60" ></div>' +
        '<div class="progressBar">' +
        '<div></div>' +
        '</div>' +
        '<div class="loading_percent">0%</div>' +
        '</div>';

    document.write(html);
</script>

<script type="module">
    import * as THREE from '../js/three.module.js';
    import Stats from '../js/libs/stats.module.js';
    import {GUI} from '../js/libs/dat.gui.module.js';
    import {OrbitControls} from '../js/controls/OrbitControls.js';
    import {GLTFLoader} from '../js/loaders/GLTFLoader.js';
    import {RGBELoader} from '../js/loaders/RGBELoader.js';
    import {RoughnessMipmapper} from '../js/loaders/RoughnessMipmapper.js';


    var camera, scene, renderer, raycaster, stats, controls;
    var clock = new THREE.Clock();
    var raycaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();

    var groupArray = [];
    var initPosition = new THREE.Vector3(-146, 0, 0);

    var raycaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();

    var meshArray = []; // 网格数组
    var modelObject;

    var spriteVector = new THREE.Vector3(-26, 12.5, -6.5);
    var sphere;
    var annotationShow = false;

    var positionY = -128;
    var index = 0;
    var annotation = $('.annotation');

    // 点击热点后, 相机移动到如下位置
    var cameraPosition4Sprite = new THREE.Vector3(-75, 25, -23);

    init();
    animate();

    //1.场景
    function initScene() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);

        window.scene = scene;
    }

    //2.透视相机
    function initCamera() {
        camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 10, 2000);
        camera.position.copy(initPosition);

        window.camera = camera;
    }

    //3.渲染器
    function initRender() {
        raycaster = new THREE.Raycaster();
        renderer = new THREE.WebGLRenderer({
            antialias: true
        });
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1;
        const pmremGenerator = new THREE.PMREMGenerator(renderer);
        pmremGenerator.compileEquirectangularShader();

        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

    }

    //4.事件
    function initEvent() {
        window.addEventListener('resize', onWindowResize, false);

        $('#rotate').click(function () {
            controls.autoRotate = !controls.autoRotate;

            if (controls.autoRotate) {
                // $(this).addClass('active');
                $(this).css('background', 'url(../images/new/旋转.png)')
            } else {
                // $(this).removeClass('active');
                $(this).css('background', 'url(../images/new/旋转停止.png)')
            }
        });

        $('#reset').click(function () {
            TweenMax.to(camera.position, 1, {x: initPosition.x, y: initPosition.y, z: initPosition.z});
        });

        $('#bgColor').click(function(){
            var display = $('#bgColors').toggle().css('display');
            
            if (display === 'block') {
                $(this).css('background', 'url(../images/new/环境2.png)')
            } else {
                $(this).css('background', 'url(../images/new/环境.png)')
            }
        });

        $('#size').click(function () {
            if ($(this).hasClass('active')) {
                $(this).removeClass('active');
            } else {
                $(this).addClass('active');
            }

            var opacity = $(this).hasClass('active') ? 1 : 0;
            for (var i = 0; i < groupArray.length; i++) {
                var group = groupArray[i];
                for (var j = 0; j < group.children.length; j++) {
                    var mesh = group.children[j];
                    TweenMax.to(mesh.material, 1, {opacity: opacity, ease: Power2.easeInOut});
                }
            }
        });

        $('#download').click(function () {
            if ($('#download').data('disabled') === true) {
                return;
            }
            $('.confirm').show();
            $('.dialog').css('marginTop', (window.innerHeight / 2 - 60) + 'px');
        });

        $('#confirm').click(function () {
            $('.confirm').hide();
            $('.loading').show();
            $('.ww-content').hide().height(0);
            annotation.hide();

            var progressBar = $('.progressBar div');
            progressBar.width(0);

            if ($('#size').hasClass('active')) {
                $('#size').removeClass('active');
                for (var i = 0; i < groupArray.length; i++) {
                    var group = groupArray[i];
                    for (var j = 0; j < group.children.length; j++) {
                        var mesh = group.children[j];
                        mesh.material.opacity = 0;
                    }
                }
            }
            // 加载高模
            modelObject.visible = false;
            loadModel('9-high.glb', 1, new THREE.Vector3(0, 0, 0), 0.1);
            $('#download').data('disabled', true).parent().css('cursor', 'not-allowed');
        });

        $('#cancel').click(function () {
            $('.confirm').hide();
        });

        annotation.click(function () {
            $('.ww-content').show().height(400);

            // 移动相机到指定位置
            TweenMax.to(camera.position, 1, {
                x: cameraPosition4Sprite.x,
                y: cameraPosition4Sprite.y,
                z: cameraPosition4Sprite.z
            });
        });

        $('#rightImg').click(function(){
            $('.ww-content').height(425).show();
            var wwMusic = document.getElementById('wwMusic');
            if (!wwMusic.load()) {
                wwMusic.play();
            }
        });

        $('.ww-close').click(function () {
            $('.ww-content').height(0);
            document.getElementById('wwMusic').pause();
        });
    }

    //5.控制
    function initControls() {
        controls = new OrbitControls(camera, renderer.domElement);
        controls.minDistance = 20;
        controls.maxDistance = 200;
        controls.enableDamping = true;
        controls.dampingFactor = 0.2;
        controls.enablePan = false;
        controls.update();
    }

    //6.光源
    function initLight(array, offset) {
        //环境光
        scene.add(new THREE.HemisphereLight(0xffffff, 0x000000, 0.4));


        //平行光1，设置光的颜色，强度，位置，是否投射阴影，阴影相机的各种参数
        var dirLight = new THREE.DirectionalLight(0xffffff, 0.2);
        dirLight.position.set(0, 100, 0);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // window.dirLight = dirLight;

        //光源辅助对象
        // var helper = new THREE.DirectionalLightHelper( dirLight, 5 );
        // scene.add( helper );

        //平行光2

        // var helper = new THREE.DirectionalLightHelper( dirLight4, 5 );
        // scene.add( helper );
    }

    //7.其它
    function initOther() {
        //x, y, z轴辅助器
        var axes = new THREE.AxesHelper(500);
        // axes.position.set(100, 100, 100);
        // scene.add(axes);

        //性能检查Stats， 可以查看当前帧数
        stats = new Stats();
        //document.body.appendChild( stats.dom );

        loadModel('MTY002235.glb', 1, new THREE.Vector3(0, 0, 0));

        sphere = new THREE.Mesh(new THREE.SphereBufferGeometry(0.5, 32, 32), new THREE.MeshBasicMaterial({
            color: 0xffffff,
            transparent: true,
            opacity: 0
        }));
        sphere.name = 'sphere';
        sphere.position.copy(spriteVector);
        scene.add(sphere);

        meshArray.push(sphere);
    }

    function loadModel(name, scale, position, initScale = 1) {
        new RGBELoader()
            .setDataType(THREE.UnsignedByteType)
            .setPath('../env/')
            .load('1.hdr', function (texture) {

                var pmremGenerator = new THREE.PMREMGenerator(renderer);
                pmremGenerator.compileEquirectangularShader();
                var envMap = pmremGenerator.fromEquirectangular(texture).texture;

                //scene.background = envMap;
                scene.environment = envMap;

                texture.dispose();
                pmremGenerator.dispose();

                render();

                var progressBar = $('.progressBar div');
                var loadingPercent = $('.loading_percent');
                // use of RoughnessMipmapper is optional
                var roughnessMipmapper = new RoughnessMipmapper(renderer);

                var loader = new GLTFLoader().setPath('../model/');
                loader.load(name, function (gltf) {
                    $('.loading').hide();

                    var object = gltf.scene;
                    object.traverse(function (child) {
                        if (child.isMesh) {
                            roughnessMipmapper.generateMipmaps(child.material);

                           // child.material.envMap = envMap;

                            meshArray.push(child);
                        }
                    });

                    new THREE.Box3().setFromObject(object).getCenter(object.position).multiplyScalar(-1);
                    object.position.copy(position);
                    scene.add(object);

                    object.scale.set(initScale, initScale, initScale);

                    modelObject = object;
                    window.modelObject = modelObject;

                    TweenMax.to(object.scale, 2, {x: scale, y: scale, z: scale, ease: Power2.easeInOut});
                    TweenMax.to(object.rotation, 1.5, {
                        x: 0, y: Math.PI / 2, z: 0, ease: Power2.easeInOut, onComplete: function () {
                            annotationShow = true;
                        }
                    });

                    roughnessMipmapper.dispose();
                    render();

                    var box3 = new THREE.Box3().setFromObject(object);
                    console.log(box3);

                    if (groupArray.length === 0) {
                        initSize(box3, scale, object.position, false);
                    }

                }, function (xhr) {
                    // console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );
                    // console.log(( xhr.loaded / xhr.total * 100 ).toFixed(2));

                    loadingPercent.text(( xhr.loaded / xhr.total * 100 ).toFixed(0) + '%');
                    progressBar.width(Math.round(xhr.loaded / xhr.total * 220));
                });
            });
    }

    $(".huan_bj").click(function() {
        var index = $(this).data("index");
        new RGBELoader()
            .setDataType( THREE.UnsignedByteType )
            .setPath( '../env/' )
            .load( index + '.hdr', function ( hdrEquirect ) {
                var hdrCubeRenderTarget = pmremGenerator.fromEquirectangular( hdrEquirect );
                hdrEquirect.dispose();
                pmremGenerator.dispose();

                scene.background = hdrCubeRenderTarget.texture;
                //scene.environment = hdrCubeRenderTarget.texture;
            } );

        var pmremGenerator = new THREE.PMREMGenerator( renderer );
        pmremGenerator.compileEquirectangularShader();
    });

    function getText(font, message) {
        var matLite = new THREE.MeshBasicMaterial({
            color: 0x000000,
            side: THREE.DoubleSide,
            transparent: true,
            opacity: 0
        });

        var shapes = font.generateShapes(message, 5);

        var geometry = new THREE.ShapeBufferGeometry(shapes);
        geometry.computeBoundingBox();

        var xMid = -0.5 * (geometry.boundingBox.max.x - geometry.boundingBox.min.x);
        geometry.translate(xMid, 0, 0);

        var text = new THREE.Mesh(geometry, matLite);
        text.position.y = 5;

        return text;
    }

    function getSizeMesh(end) {
        var w = 0.6;
        var h = 6;
        var start = new THREE.Vector2(0, 0);
        var end = new THREE.Vector2(end, 0);

        var shape = new THREE.Shape()
            .moveTo(start.x, start.y)
            .lineTo(start.x, start.y + h)
            .lineTo(end.x, end.y + h)
            .lineTo(end.x, end.y)
            .lineTo(end.x - w, end.y)
            .lineTo(end.x - w, end.y + h - w)
            .lineTo(start.x + w, start.y + h - w)
            .lineTo(start.x + w, start.y)
            .lineTo(start.x, start.y);
        var geometry = new THREE.ShapeBufferGeometry(shape);
        geometry.center();

        return new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({
            color: 0x000000,
            side: THREE.DoubleSide,
            transparent: true,
            opacity: 0
        }));
    }

    function initSize(boundingBox, scale, position, isFront) {
        var offset = 10;

        var width = scale * (boundingBox.max.x - boundingBox.min.x);
        var height = scale * (boundingBox.max.y - boundingBox.min.y);
        var depth = scale * (boundingBox.max.z - boundingBox.min.z);

        var group1 = new THREE.Group();
        group1.add(getSizeMesh(width));

        var group2 = new THREE.Group();
        group2.add(getSizeMesh(height));

        var group3 = new THREE.Group();
        group3.add(getSizeMesh(depth));

        var loader = new THREE.FontLoader();
        loader.load('../font/helvetiker_regular.typeface.json', function (font) {
            group1.add(getText(font, '32.00cm'));
            group2.add(getText(font, '40.00cm'));
            group3.add(getText(font, '38.00cm'));

            if (isFront) {
                group1.position.set(position.x, position.y + height / 2 + offset, position.z);
            } else {
                group1.position.set(position.x, position.y - offset, position.z + depth / 2 + offset);
                group1.children[0].rotation.z = Math.PI;
            }

            scene.add(group1);
            groupArray.push(group1);

            if (isFront) {
                group2.rotation.set(0, 0, Math.PI / 2);
                group2.position.set(position.x - width / 2 - offset, position.y, position.z);
            } else {
                group2.rotation.set(0, -Math.PI / 2, Math.PI / 2);
                group2.position.set(position.x, position.y, position.z - depth / 2 - offset);
            }

            scene.add(group2);
            groupArray.push(group2);

            if (isFront) {
                group3.position.set(position.x + width / 2 + offset, position.y - height / 2, position.z);
                group3.rotation.y = Math.PI / 2;
                group3.children[0].rotation.x = Math.PI;
            } else {
                group3.position.set(position.x, position.y + height / 2 + offset, position.z);
                group3.rotation.y = -Math.PI / 2;
            }
            scene.add(group3);
            groupArray.push(group3);
        });
    }

    // 初始函数，初始化各种对象
    function init() {
        initScene();
        initCamera();
        initRender();
        initEvent();
        initControls();
        initLight();
        initOther();

    }

    // 窗口缩放时自适应屏幕
    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function setupMouseCoords(event) {
        var x, y;
        if (event.changedTouches) {
            x = event.changedTouches[0].pageX;
            y = event.changedTouches[0].pageY;
        } else {
            x = event.clientX;
            y = event.clientY;
        }

        mouse.x = (x / window.innerWidth) * 2 - 1;
        mouse.y = -(y / window.innerHeight) * 2 + 1;
    }

    function world2Screen(x, y, z) {
        let worldVector = new THREE.Vector3(x, y, z);
        let vector = worldVector.project(camera);

        let halfWidth = window.innerWidth / 2;
        let halfHeight = window.innerHeight / 2;

        let result = {
            x: Math.round(vector.x * halfWidth + halfWidth),
            y: Math.round(-vector.y * halfHeight + halfHeight)
        };

        return result;
    }

    function updateScreenPosition() {
        index++;
        annotation.css('background-position', '0px ' + (Math.round(index / 3) * positionY) + 'px');

        if (index > 75) {
            index = 0;
        }

        var vector = spriteVector.clone();
        vector.project(camera);

        vector.x = Math.round((0.5 + vector.x / 2) * (window.innerWidth / window.devicePixelRatio));
        vector.y = Math.round((0.5 - vector.y / 2) * (window.innerHeight / window.devicePixelRatio));

        annotation.css({top: (vector.y - 64) + "px", left: (vector.x - 64) + "px"});

        var vector2 = world2Screen(spriteVector.x, spriteVector.y, spriteVector.z);
        setupMouseCoords({clientX: vector2.x, clientY: vector2.y});

        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects(meshArray, true);
        if (intersects.length) {
            if (intersects[0].object.name === 'sphere') {
                annotationShow && annotation.show();
            } else {
                annotation.hide();
            }
        }
    }

    function animate() {
        render();

        // updateScreenPosition();

        requestAnimationFrame(animate); //循环执行animate函数
    }

    function render() {
        controls.update();
        stats.update();

        renderer.clear();
        renderer.render(scene, camera);
    }
	
	$(document).ready(function(){
        // console.warn(myurl);
        // $(".ww-contTitle img").attr("src","/MTY/thumbnail/"+myurl+".jpg");
	});
</script>
</body>
</html>