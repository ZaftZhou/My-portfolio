<!DOCTYPE html>
<html lang="en">
<head>
	<title>CANADA GOOSE</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="stylesheet" href="./css/main.css" type="text/css">
	<script src="./js/libs/jquery.js"></script>
	<script src="./js/libs/TweenMax.min.js"></script>
</head>
<body>
	<div id="uiscaleC">
		<div id="Ctittle"></div>
		<div id="Ctext"></div>
		<!-- <div class="btnC" id="btnC_01" style="font-size: 18px;transform: translate(10px, -50px) scale(0.7);margin-right: 0px;display: none;">
			 <img draggable="false" class="btn_imgx" id="btnC_img_01" src="Img/Icon_sc/btn_06.png">
			  <div>看看拍出的照片有多棒！</div>
		</div> -->
		<div id="Cline" style="transform: translate(10px, -20px) scale(1); width: 1px; margin-right: 0px; display: none;"></div>
	</div>

	<div class="annotation1">
		<div class="line"></div>
		<div id="meshName"></div>
	</div>

	<script>
		var html = '<div class="loading">' + 
		'<div class="loading_t" style="margin-top: ' + (window.innerHeight / 2 - 60) + 'px;"><img src="./image/logo_goose.png" width="183" height="102" ></div>' + 
		'<div class="progressBar">' + 
			'<div></div>' + 
		'</div>' + 
		'<div class="loading_percent">0%</div>' + 
		'</div>';

		document.write(html);
	</script>

	<script type="module">
		import * as THREE from './js/three.module.js';
		// import Stats from './js/libs/stats.module.js';
		// import { GUI } from './js/libs/dat.gui.module.js';
		import { OrbitControls } from './js/controls/OrbitControls.js';
		import { GLTFLoader } from './js/loaders/GLTFLoader.js';
		import { RGBELoader } from './js/loaders/RGBELoader.js';
		import { FBXLoader } from './js/loaders/FBXLoader.js';
		import { RoughnessMipmapper } from './js/loaders/RoughnessMipmapper.js';

		var camera, scene, renderer, raycaster, stats, controls,composer,container,group, copyPass;
		var clock = new THREE.Clock();
		var raycaster = new THREE.Raycaster();
		var mouse = new THREE.Vector2();

		var groupArray = [];

		var isMobile = function() {
			if (window.navigator.userAgent.match(/(iPhone|iPod|Android|ios|SymbianOS)/i)) {
				return true;
			} else {
				return false;
			}
		}();

		var initPosition = new THREE.Vector3(-117, 39, -43);
		if (isMobile) {
			initPosition = new THREE.Vector3(-21, 38, 213);
		}

		var meshArray = []; // 网格数组

		var isChrome = window.navigator.userAgent.indexOf("Chrome") > -1;
		var timeDownUp = null;
		var mouseMoving = false;

		init();
		animate();

		//1.场景
		function initScene() {
			scene = new THREE.Scene();
			scene.background = new THREE.Color( 0x000000 );

			window.scene = scene;
		}

		//2.透视相机
		function initCamera() {
			camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 10, 2000);
			camera.position.copy(initPosition);
		}

		//3.渲染器
		function initRender() {
			raycaster = new THREE.Raycaster();
			renderer = new THREE.WebGLRenderer({
				antialias: true
			});
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1;
            // const pmremGenerator = new THREE.PMREMGenerator( renderer );
            // pmremGenerator.compileEquirectangularShader();

            // renderer.shadowMap.enabled = true;
			// renderer.shadowMap.type = THREE.PCFSoftShadowMap;
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.setPixelRatio(window.devicePixelRatio);
			document.body.appendChild(renderer.domElement);
		}

		//4.事件
		function initEvent() {
			window.addEventListener('resize', onWindowResize, false);
		}

		//5.控制
		function initControls() {
			controls = new OrbitControls(camera, renderer.domElement);

			controls.minDistance = 50;
            controls.maxDistance = 350;
			controls.enableDamping = true;
			controls.dampingFactor = 0.05;
            controls.enablePan = false;
			controls.update();
		}

		//6.光源
		function initLight(array, offset) {
            scene.add( new THREE.HemisphereLight( 0xfec47f, 0xfec47f, 0.1) );

            //平行光1，设置光的颜色，强度，位置，是否投射阴影，阴影相机的各种参数
            var dirLight = new THREE.DirectionalLight( 0xfec47f, 0.5 );
            dirLight.position.set( 50, 0, 100 );
            dirLight.castShadow = true;
            scene.add( dirLight );

            window.dirLight = dirLight;

            //光源辅助对象
            var helper = new THREE.DirectionalLightHelper( dirLight, 1 );
			scene.add( helper );

            //平行光2

            // var helper = new THREE.DirectionalLightHelper( dirLight4, 5 );
            // scene.add( helper );
		}

		//7.其它
		function initOther() {
			//x, y, z轴辅助器
			var axes = new THREE.AxesHelper(500);
			// axes.position.set(100, 100, 100);
			// scene.add(axes);

			//性能检查Stats， 可以查看当前帧数
			// stats = new Stats();
			//document.body.appendChild( stats.dom );

			loadModel();
		}

		function loadModel() {
			var progressBar = $('.progressBar div');
			var loadingPercent = $('.loading_percent');

			const material = new THREE.MeshStandardMaterial();
			var textureLoader = new THREE.TextureLoader();
			// const loader = textureLoader.setPath( './model/' );

			var mapLoaded = false;
			var envLoaded = false;
			
			new RGBELoader().setDataType( THREE.UnsignedByteType ).setPath( 'model/' ).load( '1.hdr', function ( texture ) {
				var pmremGenerator = new THREE.PMREMGenerator( renderer );
				pmremGenerator.compileEquirectangularShader();
				var envMap = pmremGenerator.fromEquirectangular( texture ).texture;

				//scene.background = envMap;
				scene.background = textureLoader.load('./image/pro_bg.jpg')
				scene.environment = envMap;

				texture.dispose();
				pmremGenerator.dispose();
				
				var gltfLoader = new GLTFLoader().setPath( './model/gltf/' );
				gltfLoader.load( 'new2obj8.glb', function ( gltf ) {
					var object = gltf.scene;
					var scale = 0.08;
					object.traverse(function(child){
						if (child.isMesh) {
							child.scale.set(scale, scale, scale);
							child.material.side = THREE.DoubleSide;
							child.material.environment=envMap;
                            child.receiveShadow = true;
                            child.castShadow = true;
						}
					});

					new THREE.Box3().setFromObject(object).getCenter(object.position).multiplyScalar(-1);
					scene.add(object);

					$('.loading').hide();
				}, function(xhr) {
					loadingPercent.text(( xhr.loaded / xhr.total * 100 ).toFixed(0) + '%');
					progressBar.width(Math.round( xhr.loaded / xhr.total * 220 ));
				});
			} );
		}

		// 初始函数，初始化各种对象
		function init() {
			initScene();
			initCamera();
			initRender();
			initEvent();
			initControls();
			initLight();
			initOther();
		}

		// 窗口缩放时自适应屏幕
		function onWindowResize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
		}

		function animate() {
			requestAnimationFrame(animate);
			render();
		}

		function render() {
			controls.update();
			// stats.update();

			renderer.clear();
			renderer.render(scene, camera);
		}
	</script>
</body>
</html>
